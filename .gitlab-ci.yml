stages:
  # while we have a pretty simple CI setup, we run everything on one job
  - test

test:
  image: golangci/golangci-lint
  services:
    # If you're updating the postgres image we're using, make sure you've pushed
    # this to the registry. Otherwise the tests won't run with the newest image!
    # docker login registry.gitlab.com
    #  docker build -t registry.gitlab.com/arcanecrypto/teslacoil/postgres docker/postgres/
    #  docker push registry.gitlab.com/arcanecrypto/teslacoil/postgres
    - name: registry.gitlab.com/arcanecrypto/teslacoil/postgres
      # otherwise the host is name of the image
      alias: postgres
  only:
    - merge_requests
  stage: test
  # This is a hack, but that's because GitLab doesn't respect GOPATH etc
  # https://medium.com/@Extrawurst/golang-and-gitlab-ci-da97d11bafe1
  cache:
    paths:
      - .cache
      - .binaries
  variables:
    DATABASE_HOST: postgres
  before_script: 
    # setup binaries directory
    - mkdir -p .binaries
    - export PATH=$PWD/.binaries/:$PATH

    # download binaries into newly created binaries directory
    - ./scripts/download-lnd.sh
    - ./scripts/download-bitcoind.sh

    # cache things properly
    - mkdir -p $CI_PROJECT_DIR/.cache
    - export GOPATH="$CI_PROJECT_DIR/.cache"

    # make sure we're using Go modules
    - export GO111MODULE=on
  script:
    # run tests
    - go test -cover -tags integration  ./...

    # run linter
    - make lint
